{% extends "base.html" %}

{% block title %}WhatsApp Business Registration{% endblock %}

{% block content %}
<div class="flex flex-col items-center justify-center min-h-[80vh] max-w-4xl mx-auto">
    <div class="bg-secondary p-8 rounded-lg shadow-lg w-full">
        <h1 class="text-2xl font-bold mb-6 text-center">WhatsApp Business Registration</h1>
        
        <!-- Debug info - shows in development only -->
        <!-- <div class="mb-4 p-4 bg-gray-800 rounded-lg text-xs overflow-auto">
            <p>App ID: {{ app_id or 'Not set' }}</p>
            <p>Configuration ID: {{ config_id or 'Not set' }}</p>
            <p>Success URL: {{ success_url }}</p>
            <p>Error URL: {{ error_url }}</p>
            <div id="debug-log" class="mt-2"></div>
        </div> -->
        
        <div class="mb-8">
            <p class="text-gray-400 mb-6">
                Connect your business with WhatsApp to enable automated messaging through our platform.
                This process allows us to send messages on behalf of your business.
            </p>
            
            <div class="bg-gray-800 p-6 rounded-lg mb-6">
                <h2 class="text-lg font-semibold mb-4">What happens during setup:</h2>
                <ol class="list-decimal list-inside space-y-2 text-gray-300">
                    <li>You'll connect your WhatsApp business account</li>
                    <li>Verify your business information</li>
                    <li>Select which phone numbers to use with our platform</li>
                    <li>Authorize our application to send messages</li>
                </ol>
            </div>
            
            <!-- WhatsApp Sign-up UI -->
            <div id="whatsapp-signup-container" class="min-h-[200px] w-full flex flex-col items-center justify-center bg-gray-900 border border-gray-700 rounded-lg p-6">
                <p class="text-gray-400 mb-4">Click the button below to connect your WhatsApp Business Account</p>
                
                <!-- Launch button styled to match your UI -->
                <button id="wa-signup-button" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"></path>
                        <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm0 22c-5.523 0-10-4.477-10-10S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10z"></path>
                    </svg>
                    Connect WhatsApp Business
                </button>
                
                <p id="loading-status" class="text-sm text-gray-500 mt-4"></p>
            </div>
        </div>
        
        <div class="text-center">
            <p class="text-gray-400 mb-4">
                Need help? <a href="#" class="text-blue-400 hover:underline">Contact our support team</a>
            </p>
            <a href="{{ url_for('index') }}" class="text-gray-400 hover:text-white">
                ‚Üê Back to dashboard
            </a>
        </div>
    </div>
</div>

<!-- Standard Facebook SDK loading (as per documentation) -->
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>

<script>
    // Debug logging function
    function logDebug(message) {
        console.log("WhatsApp Debug:", message);
        const debugLog = document.getElementById('debug-log');
        if (debugLog) {
            const time = new Date().toLocaleTimeString();
            debugLog.innerHTML += `<div>[${time}] ${message}</div>`;
        }
        
        const status = document.getElementById('loading-status');
        if (status) {
            status.innerText = message;
        }
    }
    
    // Initialize Facebook SDK (as per documentation)
    window.fbAsyncInit = function() {
        logDebug("SDK loaded, initializing...");
        
        try {
            // Initialize the SDK
            FB.init({
                appId: '{{ app_id }}',
                autoLogAppEvents: true,
                xfbml: true,
                version: 'v17.0' // Graph API version
            });
            
            logDebug("FB SDK initialized successfully");
            
            // Enable the button after SDK is loaded
            document.getElementById('wa-signup-button').addEventListener('click', launchWhatsAppSignup);
            document.getElementById('wa-signup-button').disabled = false;
        } catch (error) {
            logDebug("Error initializing FB SDK: " + error.message);
        }
    };
    
    // Session logging message event listener (as per documentation)
    window.addEventListener('message', (event) => {
        if (event.origin !== "https://www.facebook.com" && event.origin !== "https://web.facebook.com") return;
        
        try {
            const data = JSON.parse(event.data);
            if (data.type === 'WA_EMBEDDED_SIGNUP') {
                logDebug('WhatsApp signup message event: ' + JSON.stringify(data));
                
                // Handle different states if needed
                if (data.event === 'COMPLETED') {
                    logDebug('Signup completed!');
                }
            }
        } catch (e) {
            logDebug('Received message event: ' + event.data);
        }
    });
    
    // Response callback for FB.login (as per documentation)
    const fbLoginCallback = (response) => {
        logDebug('Login callback received');
        
        if (response.authResponse) {
            const code = response.authResponse.code;
            logDebug('Received authorization code: ' + code);
            
            // Send the code to server for processing
            fetch('{{ url_for("whatsapp_signup_callback") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code
                })
            })
            .then(response => response.json())
            .then(data => {
                logDebug('Server response: ' + JSON.stringify(data));
                
                if (data.success) {
                    // Redirect to success page
                    window.location.href = '{{ success_url }}';
                } else {
                    logDebug('Error from server: ' + data.error);
                }
            })
            .catch(error => {
                logDebug('Error processing response: ' + error);
            });
        } else {
            logDebug('Login failed or was cancelled: ' + JSON.stringify(response));
        }
    };
    
    // Launch method for WhatsApp signup (as per documentation)
    const launchWhatsAppSignup = () => {
        logDebug('Launching WhatsApp signup...');
        
        // Check if FB is available
        if (typeof FB === 'undefined') {
            logDebug('Facebook SDK not loaded yet');
            return;
        }
        
        try {
            // Call FB.login with WhatsApp configuration
            FB.login(fbLoginCallback, {
                config_id: '{{ config_id }}',  // Configuration ID from Meta Business Manager
                response_type: 'code',
                override_default_response_type: true,
                extras: {
                    setup: {},
                    featureType: '',
                    sessionInfoVersion: '3',
                }
            });
        } catch (error) {
            logDebug('Error launching WhatsApp signup: ' + error.message);
        }
    };
</script>
{% endblock %}
